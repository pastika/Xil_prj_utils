#!/bin/bash
#
set -e

# Authenticate user via Kerberos
kinit="/usr/bin/kinit"
if [ ! -x $kinit ]
then
        echo "ERROR: $kinit not found"
        exit 1
fi

kdestroy="/usr/bin/kdestroy"
if [ ! -x $kdestroy ]
then
        echo "ERROR: $kdestroy not found"
        exit 1
fi
# Validate input
if [ $# -ne 1 ]
then
        echo "ERROR: updaterepo needs exactly one argument: the path eos to the root of the repository"
        exit 1
fi

# Get credentials
echo "$EOS_ACCOUNT_PASSWORD" | $kinit "$EOS_ACCOUNT_USERNAME@CERN.CH" 2>&1 >/dev/null
if [ $? -ne 0 ]
then
	echo "Failed to get Krb5 credentials for '$EOS_ACCOUNT_USERNAME'"
        exit 1
fi

# SSH will be used to connect to LXPLUS and there check if the EOS folder exists
ssh="/usr/bin/ssh"
if [ ! -x $ssh ]
then
    echo ERROR: $ssh not found
    exit 1
fi

# Check that the connection to lxplus is possible
$ssh -o StrictHostKeyChecking=no -o GSSAPIAuthentication=yes -o GSSAPITrustDNS=yes -o GSSAPIDelegateCredentials=yes $EOS_ACCOUNT_USERNAME@lxplus.cern.ch 'whoami; echo 0' > /dev/null 2>&1
if [ $? -ne 0 ]
then
    echo ERROR: Not possible to connect to lxplus.cern.ch with user \"$EOS_ACCOUNT_USERNAME\"
    exit 1
fi

# Update repodata with EOS
$ssh -o StrictHostKeyChecking=no -o GSSAPIAuthentication=yes -o GSSAPITrustDNS=yes -o GSSAPIDelegateCredentials=yes $EOS_ACCOUNT_USERNAME@lxplus.cern.ch "cd $1 && createrepo --update --database . && echo 0" 
if [ $? -ne 0 ]
then
    echo "ERROR: Createrepo $1 via lxplus.cern.ch, failed"
    exit 1
fi

# Destroy credentials
$kdestroy
if [ $? -ne 0 ]
then
    echo "Krb5 credentials for '$EOS_ACCOUNT_USERNAME' have not been cleared up"
fi

echo "Updated EOS web repodata in $1"
exit 0
